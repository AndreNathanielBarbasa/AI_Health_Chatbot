<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Registration - AI Health Chatbot</title>
    <link rel="stylesheet" href="form.css" />
  </head>
  <body>
    <!-- Background Image Container -->
    <div class="background-image"></div>
    <div class="background-overlay"></div>

    <!-- Patient Registration Form -->
    <div class="registration-container">
      <h2>Patient Registration</h2>
      <p class="registration-subtitle">
        Please fill in your information to start
      </p>

      <form id="registration-form" class="registration-form">
        <div class="form-group">
          <label for="firstName">First Name *</label>
          <input type="text" id="firstName" name="firstName" required />
        </div>

        <div class="form-group">
          <label for="lastName">Last Name *</label>
          <input type="text" id="lastName" name="lastName" required />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="age">Age *</label>
            <input
              type="number"
              id="age"
              name="age"
              required
              min="1"
              max="120"
            />
          </div>

          <div class="form-group">
            <label for="sex">Sex *</label>
            <select id="sex" name="sex" required>
              <option value="">Select</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="address">Address</label>
          <input
            type="text"
            id="address"
            name="address"
            placeholder="e.g. Taft Street Santa Barbara, Iloilo"
          />
        </div>

        <div class="form-group">
          <label for="contactNumber">Contact Number</label>
          <input
            type="tel"
            id="contactNumber"
            name="contactNumber"
            placeholder="09XX XXX XXXX"
          />
        </div>

        <div class="form-group">
          <label for="medicalHistory">Medical History (Optional)</label>
          <textarea
            id="medicalHistory"
            name="medicalHistory"
            rows="3"
            placeholder="Any allergies, existing conditions, or medications you're currently taking..."
          ></textarea>
        </div>

        <button type="submit" class="register-btn">Start Chat with Tam</button>
      </form>
    </div>

    <script>
      document
        .getElementById("registration-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Ask for confirmation BEFORE sending
          const userConfirm = confirm(
            "Are you sure you want to submit your information?"
          );
          if (!userConfirm) {
            console.log("User canceled the submission.");
            return; // Stop everything
          }

          console.log("Form submitted!"); // Debug message

          // Get form data
          const patientData = {
            firstName: document.getElementById("firstName").value,
            lastName: document.getElementById("lastName").value,
            age: parseInt(document.getElementById("age").value),
            sex: document.getElementById("sex").value,
            address: document.getElementById("address").value,
            contactNumber: document.getElementById("contactNumber").value,
            medicalHistory: document.getElementById("medicalHistory").value,
          };

          console.log("Patient Data:", patientData);

          try {
            console.log("Sending to backend...");

            // Send to backend
            const response = await fetch(
              "http://127.0.0.1:5000/register-patient",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(patientData),
              }
            );

            console.log("Response received:", response.status);

            const result = await response.json();
            console.log("Result:", result);

            if (result.success) {
              console.log("âœ… Patient registered! ID:", result.patient_id);
              alert(
                "Patient registered successfully! ID: " + result.patient_id
              );

              // Save patient_id to localStorage
              localStorage.setItem("patient_id", result.patient_id);
              localStorage.setItem("patientData", JSON.stringify(patientData));

              console.log("Redirecting to chat...");

              setTimeout(() => {
                window.location.href = "waiting.html";
              }, 500);
            } else {
              alert("Failed to register patient: " + result.message);
              console.error("Registration failed:", result);
            }
          } catch (error) {
            console.error("Error:", error);
            alert("Error connecting to server: " + error.message);
          }
        });
    </script>
  </body>
</html>
